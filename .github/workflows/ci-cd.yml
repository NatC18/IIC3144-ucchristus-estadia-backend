name: ðŸš€ CI/CD Pipeline - UC Christus Backend

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  # Variables de base de datos
  DB_NAME: ucchristus_test_db
  DB_USER: test_user
  DB_PASSWORD: test_password
  DB_HOST: localhost
  DB_PORT: 5432
  
  # Variables Django adicionales
  DEBUG: 1
  SECRET_KEY: test-secret-key-for-ci
  AUTH0_DOMAIN: test.auth0.com
  AUTH0_AUDIENCE: test-audience
  AUTH0_CLIENT_ID: test-client-id
  AUTH0_CLIENT_SECRET: test-client-secret

jobs:
  # ðŸ” AnÃ¡lisis de cÃ³digo
  code-quality:
    name: ðŸ“Š Code Quality & Security
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.13'
        
    - name: ðŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install flake8 bandit safety
        pip install -r requirements.txt
        
    - name: ðŸ” Lint with flake8
      run: |
        # Detener si hay errores de sintaxis o nombres no definidos
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        # Advertencias generales
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
        
    - name: ðŸ”’ Security scan with bandit
      run: |
        bandit -r . -x ./venv/,./staticfiles/ || true
        
    - name: ðŸ›¡ï¸ Check dependencies for vulnerabilities
      run: |
        safety check || true

  # ðŸ§ª Tests y Build
  test-and-build:
    name: ðŸ§ª Test & Build
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: ${{ env.DB_NAME }}
          POSTGRES_USER: ${{ env.DB_USER }}
          POSTGRES_PASSWORD: ${{ env.DB_PASSWORD }}
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
          
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.13'
        
    - name: ðŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: ðŸ—„ï¸ Run migrations
      run: |
        python manage.py migrate --verbosity=0
        
    - name: ðŸ§ª Run Django tests
      run: |
        python manage.py test --verbosity=2
        
    - name: âœ… Django system check
      run: |
        python manage.py check --deploy
        
    - name: ðŸ“Š Collect static files
      run: |
        python manage.py collectstatic --noinput
        
    - name: ðŸ³ Build Docker image
      run: |
        docker build -t ucchristus-backend:${{ github.sha }} .
        
    - name: ðŸ” Test Docker image
      env:
        SECRET_KEY: ${{ env.SECRET_KEY }}
        DEBUG: ${{ env.DEBUG }}
      run: |
        docker run --rm ucchristus-backend:${{ github.sha }} python manage.py check

  # ðŸš€ Preparar deployment (solo en main)
  prepare-deploy:
    name: ðŸš€ Prepare Deployment
    needs: [code-quality, test-and-build]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ³ Build production image
      run: |
        docker build -t ucchristus-backend:latest .
        
    - name: ðŸ“‹ Create deployment summary
      run: |
        echo "## ðŸŽ‰ Deployment Ready!" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… All tests passed" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Docker image built successfully" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Static files collected" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸš€ Ready for production deployment" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Next Steps:" >> $GITHUB_STEP_SUMMARY
        echo "1. Deploy to Render/Railway" >> $GITHUB_STEP_SUMMARY
        echo "2. Run migrations in production" >> $GITHUB_STEP_SUMMARY
        echo "3. Verify health checks" >> $GITHUB_STEP_SUMMARY

  # ðŸ“Š Reporte final
  report:
    name: ðŸ“Š Pipeline Report
    needs: [code-quality, test-and-build]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: ðŸ“‹ Generate report
      run: |
        echo "## ðŸ“Š Pipeline Summary" >> $GITHUB_STEP_SUMMARY
        echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Code Quality | ${{ needs.code-quality.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Test & Build | ${{ needs.test-and-build.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [[ "${{ needs.code-quality.result }}" == "success" && "${{ needs.test-and-build.result }}" == "success" ]]; then
          echo "ðŸŽ‰ **All checks passed! Ready for deployment** ðŸš€" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Some checks failed. Please review and fix issues.** ðŸ”§" >> $GITHUB_STEP_SUMMARY
        fi